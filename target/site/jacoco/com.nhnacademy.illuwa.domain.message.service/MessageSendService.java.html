<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessageSendService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">1lluwa-user-service</a> &gt; <a href="index.source.html" class="el_package">com.nhnacademy.illuwa.domain.message.service</a> &gt; <span class="el_source">MessageSendService.java</span></div><h1>MessageSendService.java</h1><pre class="source lang-java linenums">package com.nhnacademy.illuwa.domain.message.service;

import com.nhnacademy.illuwa.common.client.DoorayMessageClient;
import com.nhnacademy.illuwa.domain.member.dto.MemberResponse;
import com.nhnacademy.illuwa.domain.member.entity.enums.Status;
import com.nhnacademy.illuwa.domain.member.service.MemberService;
import com.nhnacademy.illuwa.domain.message.dto.SendMessageRequest;
import com.nhnacademy.illuwa.domain.message.dto.SendMessageResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

import java.security.SecureRandom;
import java.util.*;
import java.util.concurrent.TimeUnit;

<span class="fc" id="L18">@Slf4j</span>
@Service
<span class="fc" id="L20">@RequiredArgsConstructor</span>
public class MessageSendService {
    private final DoorayMessageClient doorayMessageClient;
    private final MemberService memberService;
    private final RedisTemplate&lt;String, String&gt; redisTemplate;

<span class="fc" id="L26">    private static final SecureRandom SECURE_RANDOM = new SecureRandom();</span>

    public SendMessageResponse sendDoorayMessage(SendMessageRequest request) {
<span class="fc" id="L29">        Map&lt;String, Object&gt; body = new HashMap&lt;&gt;();</span>
<span class="fc" id="L30">        body.put(&quot;botName&quot;, request.getBotName());</span>
<span class="fc bfc" id="L31" title="All 2 branches covered.">        if(request.getText() != null){</span>
<span class="fc" id="L32">            body.put(&quot;text&quot;, request.getText());</span>
        }

<span class="fc bfc" id="L35" title="All 2 branches covered.">        if(request.hasAttachment()){</span>
<span class="fc" id="L36">            Map&lt;String, Object&gt; attachment = new HashMap&lt;&gt;();</span>

<span class="fc" id="L38">            attachment.put(&quot;title&quot;, request.getAttachmentTitle());</span>
<span class="fc" id="L39">            attachment.put(&quot;text&quot;, request.getAttachmentText());</span>
<span class="fc" id="L40">            attachment.put(&quot;color&quot;, request.getAttachmentColor());</span>

<span class="fc" id="L42">            body.put(&quot;attachments&quot;, List.of(attachment));</span>
        }
        try {
<span class="fc" id="L45">            doorayMessageClient.sendMessage(body);</span>
<span class="fc" id="L46">            String message = &quot;두레이 메시지 전송 성공!&quot;;</span>
<span class="fc" id="L47">            log.debug(message);</span>
<span class="fc" id="L48">            return new SendMessageResponse(request.getRecipientEmail(), message);</span>
<span class="fc" id="L49">        } catch (Exception e) {</span>
<span class="fc" id="L50">            String message = &quot;두레이 메시지 전송 실패!&quot;;</span>
<span class="fc" id="L51">            log.error(message + &quot;{}&quot;, e.getMessage());</span>
<span class="fc" id="L52">            return new SendMessageResponse(request.getRecipientEmail(), message);</span>
        }
    }

    //주문완료 메시지
    public void sendOrderMessage(SendMessageRequest request, String orderNumber) {
<span class="fc" id="L58">        request.setText(request.getRecipientName() + &quot;님의 소중한 주문이 완료되었습니다!😎&quot;);</span>
<span class="fc" id="L59">        request.setAttachmentTitle(&quot;🎁주문완료&quot;);</span>
<span class="fc" id="L60">        request.setAttachmentText(&quot;주문번호: &quot; + &quot;[&quot; + orderNumber + &quot;]&quot;);</span>
<span class="fc" id="L61">        sendDoorayMessage(request);</span>
<span class="fc" id="L62">    }</span>

    //인증번호 메시지
    public void sendVerificationCode(SendMessageRequest request) {
<span class="fc" id="L66">        MemberResponse memberDto = memberService.getMemberByEmail(request.getRecipientEmail());</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">        if (!memberDto.getStatus().equals(Status.INACTIVE)) {</span>
<span class="fc" id="L68">            throw new IllegalStateException(&quot;휴면 회원만 인증이 필요합니다!&quot;);</span>
        }
<span class="fc" id="L70">        String code = generateVerificationCode();</span>
<span class="fc" id="L71">        String key = &quot;verify:&quot; + request.getRecipientEmail();</span>

<span class="fc" id="L73">        redisTemplate.opsForValue().set(key, code, 3, TimeUnit.MINUTES);</span>

<span class="fc" id="L75">        String messageText = request.getRecipientName() + &quot;님 🙌\n&quot; +</span>
                &quot;휴면해제를 위해 아래 인증번호를 입력해주세요.&quot;;

<span class="fc" id="L78">        request.setText(messageText);</span>
<span class="fc" id="L79">        request.setAttachmentTitle(&quot;🔑인증번호&quot;);</span>
<span class="fc" id="L80">        request.setAttachmentText(&quot;[&quot; + code + &quot;]&quot; + &quot;\n3분 동안 유효합니다.&quot;);</span>
<span class="fc" id="L81">        request.setAttachmentColor(&quot;red&quot;);</span>
<span class="fc" id="L82">        sendDoorayMessage(request);</span>
<span class="fc" id="L83">    }</span>

    //인증번호 생성
    public String generateVerificationCode() {
<span class="fc" id="L87">        int code = SECURE_RANDOM.nextInt(900_000) + 100_000;</span>
<span class="fc" id="L88">        return String.valueOf(code);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>