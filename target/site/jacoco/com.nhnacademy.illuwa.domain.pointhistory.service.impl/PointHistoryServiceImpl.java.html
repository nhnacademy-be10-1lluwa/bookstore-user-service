<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PointHistoryServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">1lluwa-user-service</a> &gt; <a href="index.source.html" class="el_package">com.nhnacademy.illuwa.domain.pointhistory.service.impl</a> &gt; <span class="el_source">PointHistoryServiceImpl.java</span></div><h1>PointHistoryServiceImpl.java</h1><pre class="source lang-java linenums">package com.nhnacademy.illuwa.domain.pointhistory.service.impl;

import com.nhnacademy.illuwa.domain.grade.entity.Grade;
import com.nhnacademy.illuwa.domain.grade.entity.enums.GradeName;
import com.nhnacademy.illuwa.domain.grade.service.GradeService;
import com.nhnacademy.illuwa.domain.member.exception.MemberNotFoundException;
import com.nhnacademy.illuwa.domain.member.service.MemberService;
import com.nhnacademy.illuwa.domain.pointhistory.dto.PointAfterOrderRequest;
import com.nhnacademy.illuwa.domain.pointhistory.dto.PointHistoryResponse;
import com.nhnacademy.illuwa.domain.pointhistory.dto.UsedPointRequest;
import com.nhnacademy.illuwa.domain.pointhistory.entity.PointHistory;
import com.nhnacademy.illuwa.domain.pointhistory.entity.enums.PointHistoryType;
import com.nhnacademy.illuwa.domain.pointhistory.entity.enums.PointReason;
import com.nhnacademy.illuwa.domain.pointhistory.repo.PointHistoryRepository;
import com.nhnacademy.illuwa.domain.pointhistory.service.PointHistoryService;
import com.nhnacademy.illuwa.domain.pointhistory.util.PointHistoryMapper;
import com.nhnacademy.illuwa.domain.pointpolicy.dto.PointPolicyResponse;
import com.nhnacademy.illuwa.domain.pointpolicy.exception.PointPolicyNotFoundException;
import com.nhnacademy.illuwa.domain.pointpolicy.service.PointPolicyService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;

@Service
@Transactional
<span class="fc" id="L30">@RequiredArgsConstructor</span>
public class PointHistoryServiceImpl implements PointHistoryService {
    private final PointHistoryRepository pointHistoryRepository;
    private final PointHistoryMapper pointHistoryMapper;
    private final PointPolicyService pointPolicyService;
    private final GradeService gradeService;
    private final MemberService memberService;

    private static final String BOOK_DEFAULT_RATE = &quot;book_default_rate&quot;;

    @Override
    public PointHistoryResponse processUsedPoint(UsedPointRequest request){
<span class="nc" id="L42">        BigDecimal point = request.getUsedPoint().negate();  //음수 전환</span>
<span class="nc" id="L43">        memberService.updateMemberPoint(request.getMemberId(), point);</span>
<span class="nc" id="L44">        return recordPointHistory(request.getMemberId(), point, PointReason.USED_IN_ORDER);</span>
    }

    @Override
    public PointHistoryResponse processOrderPoint(PointAfterOrderRequest request) {
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if(memberService.isNotActiveMember(request.getMemberId())){</span>
<span class="nc" id="L50">            throw new MemberNotFoundException();</span>
        }
<span class="nc" id="L52">        BigDecimal point = calculateByOrder(request);</span>
<span class="nc" id="L53">        memberService.updateMemberPoint(request.getMemberId(), point);</span>
<span class="nc" id="L54">        return recordPointHistory(request.getMemberId(), point, PointReason.PURCHASE);</span>
    }

    @Override
    public PointHistoryResponse processEventPoint(long memberId, PointReason reason) {
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if(memberService.isNotActiveMember(memberId)){</span>
<span class="nc" id="L60">            throw new MemberNotFoundException();</span>
        }
<span class="nc" id="L62">        PointPolicyResponse policy = pointPolicyService.findByPolicyKey(reason.getPolicyKey().orElseThrow(PointPolicyNotFoundException::new));</span>
<span class="nc" id="L63">        BigDecimal point = calculatedFromPolicy(policy);</span>
<span class="nc" id="L64">        memberService.updateMemberPoint(memberId, point);</span>
<span class="nc" id="L65">        return recordPointHistory(memberId, point, reason);</span>
    }

    @Override
    public PointHistoryResponse recordPointHistory(long memberId, BigDecimal point, PointReason reason){
<span class="nc" id="L70">        PointHistory pointHistory = PointHistory.builder()</span>
<span class="nc" id="L71">                .memberId(memberId)</span>
<span class="nc" id="L72">                .amount(point)</span>
<span class="nc" id="L73">                .reason(reason)</span>
<span class="nc" id="L74">                .createdAt(LocalDateTime.now())</span>
<span class="nc" id="L75">                .build();</span>

<span class="nc bnc" id="L77" title="All 2 branches missed.">        PointHistoryType type = point.compareTo(java.math.BigDecimal.ZERO) &gt; 0 ? PointHistoryType.EARN : PointHistoryType.USE;</span>
<span class="nc" id="L78">        pointHistory.setType(type);</span>

<span class="nc" id="L80">        return pointHistoryMapper.toDto(pointHistoryRepository.save(pointHistory));</span>
    }

    @Override
    public List&lt;PointHistoryResponse&gt; getMemberPointHistories(long memberId){
<span class="nc" id="L85">        return pointHistoryRepository.findByMemberIdOrderByCreatedAtDesc(memberId)</span>
<span class="nc" id="L86">                .stream().map(pointHistoryMapper::toDto).toList();</span>
    }

    private BigDecimal calculatedFromPolicy(PointPolicyResponse policy) {
        //AMOUNT 타입만 있지만 추후 RATE 타입은 다르게 리턴
<span class="nc" id="L91">        return policy.getValue();</span>
    }

    private BigDecimal calculateByOrder(PointAfterOrderRequest request) {
<span class="nc" id="L95">        GradeName gradeName = GradeName.valueOf(memberService.getMemberById(request.getMemberId()).getGradeName());</span>
<span class="nc" id="L96">        Grade grade = gradeService.getByGradeName(gradeName);</span>

<span class="nc" id="L98">        BigDecimal netOrderAmount = request.getNetOrderAmount();</span>

        //기본적립
<span class="nc" id="L101">        BigDecimal defaultRate = pointPolicyService.findByPolicyKey(BOOK_DEFAULT_RATE).getValue();</span>
<span class="nc" id="L102">        BigDecimal defaultPoint = netOrderAmount.multiply(defaultRate);</span>
        //구매 후 등급별 적립
<span class="nc" id="L104">        BigDecimal gradePoint = netOrderAmount.multiply(grade.getPointRate());</span>
<span class="nc" id="L105">        return defaultPoint.add(gradePoint);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>